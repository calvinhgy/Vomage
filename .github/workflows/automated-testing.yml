name: ğŸ§ª Automated Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  MONGODB_VERSION: '5.0'
  REDIS_VERSION: '6.2'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Type checking
        run: npm run type-check

      - name: ğŸ§¹ Linting
        run: npm run lint

      - name: ğŸ’… Format checking
        run: npm run format -- --check

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit:coverage

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“‹ Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      mongodb:
        image: mongo:${{ env.MONGODB_VERSION }}
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:${{ env.REDIS_VERSION }}
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”— Run integration tests
        run: npm run test:integration
        env:
          MONGODB_URI: mongodb://localhost:27017/vomage-test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: test-results/

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: ğŸŒ E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        device: [desktop, mobile]
        exclude:
          # Firefoxåœ¨ç§»åŠ¨ç«¯æµ‹è¯•ä¸­å¯èƒ½ä¸ç¨³å®š
          - browser: firefox
            device: mobile
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npm run playwright:install

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸŒ Run E2E tests
        run: |
          if [ "${{ matrix.device }}" = "mobile" ]; then
            npx playwright test --project="Mobile*"
          else
            npx playwright test --project="${{ matrix.browser }}"
          fi
        env:
          TEST_BASE_URL: http://localhost:3000

      - name: ğŸ“Š Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results-${{ matrix.browser }}-${{ matrix.device }}
          path: |
            test-results/
            playwright-report/

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ“¥ Install Artillery
        run: npm install -g artillery@latest

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸš€ Start application
        run: npm start &
        env:
          PORT: 3000

      - name: â³ Wait for application
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: âš¡ Run performance tests
        run: npm run test:performance

      - name: ğŸ“Š Upload performance results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-results
          path: test-results/performance/

  # å®‰å…¨æµ‹è¯•
  security-tests:
    name: ğŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ğŸ”’ Run CodeQL analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ğŸ” Perform CodeQL analysis
        uses: github/codeql-action/analyze@v2

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, security-tests]
    if: always()
    steps:
      - name: ğŸ“¥ Download all test artifacts
        uses: actions/download-artifact@v3

      - name: ğŸ“Š Generate test summary
        run: |
          echo "# ğŸ§ª æµ‹è¯•æ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥å„ä¸ªæµ‹è¯•ä»»åŠ¡çš„çŠ¶æ€
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "âœ… å•å…ƒæµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å•å…ƒæµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "âœ… é›†æˆæµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ é›†æˆæµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "âœ… ç«¯åˆ°ç«¯æµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ç«¯åˆ°ç«¯æµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.performance-tests.result }}" = "success" ]; then
            echo "âœ… æ€§èƒ½æµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.performance-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ æ€§èƒ½æµ‹è¯•: è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ€§èƒ½æµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-tests.result }}" = "success" ]; then
            echo "âœ… å®‰å…¨æµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å®‰å…¨æµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šè¯·æŸ¥çœ‹å„ä¸ªä»»åŠ¡çš„è¾“å‡ºå’Œä¸Šä¼ çš„æµ‹è¯•ç»“æœæ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ')
            );
            
            const testResults = {
              unit: '${{ needs.unit-tests.result }}',
              integration: '${{ needs.integration-tests.result }}',
              e2e: '${{ needs.e2e-tests.result }}',
              performance: '${{ needs.performance-tests.result }}',
              security: '${{ needs.security-tests.result }}'
            };
            
            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'â³';
              }
            };
            
            const commentBody = `## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ
            
            | æµ‹è¯•ç±»å‹ | çŠ¶æ€ | ç»“æœ |
            |---------|------|------|
            | å•å…ƒæµ‹è¯• | ${getStatusEmoji(testResults.unit)} | ${testResults.unit} |
            | é›†æˆæµ‹è¯• | ${getStatusEmoji(testResults.integration)} | ${testResults.integration} |
            | ç«¯åˆ°ç«¯æµ‹è¯• | ${getStatusEmoji(testResults.e2e)} | ${testResults.e2e} |
            | æ€§èƒ½æµ‹è¯• | ${getStatusEmoji(testResults.performance)} | ${testResults.performance} |
            | å®‰å…¨æµ‹è¯• | ${getStatusEmoji(testResults.security)} | ${testResults.security} |
            
            ğŸ“Š **æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š**: è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¦†ç›–ç‡è¯„è®º
            ğŸ“‹ **è¯¦ç»†æŠ¥å‘Š**: è¯·æŸ¥çœ‹å„ä¸ªæ£€æŸ¥çš„è¯¦ç»†è¾“å‡º
            
            ---
            *æ­¤è¯„è®ºç”±è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿ç”Ÿæˆ ğŸ¤–*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to staging
        run: |
          echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
          # ä¾‹å¦‚: AWS CLI, Docker, Kubernetesç­‰

      - name: ğŸ§ª Run smoke tests
        run: |
          echo "è¿è¡Œå†’çƒŸæµ‹è¯•..."
          # éƒ¨ç½²åçš„åŸºæœ¬åŠŸèƒ½éªŒè¯

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, security-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŒŸ Deploy to production
        run: |
          echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          # è¿™é‡Œæ·»åŠ å®é™…çš„ç”Ÿäº§éƒ¨ç½²è„šæœ¬

      - name: ğŸ§ª Run production smoke tests
        run: |
          echo "è¿è¡Œç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•..."
          # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åéªŒè¯
