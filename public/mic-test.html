<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦å…‹é£æµ‹è¯• - Vomage</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 32px;
            max-width: 500px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 24px;
        }
        .info-box {
            background: #f3f4f6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .info-box h3 {
            margin: 0 0 12px 0;
            color: #374151;
        }
        .info-box p {
            margin: 4px 0;
            font-size: 14px;
            color: #6b7280;
        }
        .status {
            text-align: center;
            margin: 24px 0;
            padding: 16px;
            border-radius: 8px;
            font-weight: 500;
        }
        .status.waiting {
            background: #e5e7eb;
            color: #374151;
        }
        .status.loading {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        button {
            display: block;
            width: 100%;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }
        button:hover:not(:disabled) {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .tips {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }
        .tips li {
            margin-bottom: 4px;
        }
        .ios-tips {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        .ios-tips h4 {
            color: #065f46;
            margin: 0 0 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ éº¦å…‹é£æƒé™æµ‹è¯•</h1>
        
        <div class="info-box">
            <h3>ç¯å¢ƒä¿¡æ¯</h3>
            <p id="protocol">åè®®: æ£€æµ‹ä¸­...</p>
            <p id="hostname">ä¸»æœº: æ£€æµ‹ä¸­...</p>
            <p id="port">ç«¯å£: æ£€æµ‹ä¸­...</p>
            <p id="secure">å®‰å…¨ä¸Šä¸‹æ–‡: æ£€æµ‹ä¸­...</p>
            <p id="device">è®¾å¤‡ç±»å‹: æ£€æµ‹ä¸­...</p>
            <p id="browser">æµè§ˆå™¨: æ£€æµ‹ä¸­...</p>
        </div>
        
        <div id="status" class="status waiting">
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•éº¦å…‹é£æƒé™
        </div>
        
        <button id="testBtn" onclick="testMicrophone()">
            ğŸ¤ æµ‹è¯•éº¦å…‹é£æƒé™
        </button>
        
        <div class="tips">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
            <ul>
                <li>ç‚¹å‡»æŒ‰é’®åæµè§ˆå™¨ä¼šè¯·æ±‚éº¦å…‹é£æƒé™</li>
                <li>è¯·åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ç‚¹å‡»"å…è®¸"</li>
                <li>å¦‚æœæ²¡æœ‰å¼¹å‡ºå¯¹è¯æ¡†ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®</li>
            </ul>
        </div>
        
        <div id="iosTips" class="ios-tips" style="display: none;">
            <h4>ğŸ“± iPhone ç”¨æˆ·ç‰¹åˆ«æç¤º</h4>
            <ol>
                <li>ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆSafariæµè§ˆå™¨</li>
                <li>ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„"aA"å›¾æ ‡ â†’ ç½‘ç«™è®¾ç½® â†’ å…è®¸éº¦å…‹é£</li>
                <li>æˆ–è€…ï¼šè®¾ç½® â†’ Safari â†’ ç½‘ç«™è®¾ç½® â†’ éº¦å…‹é£ â†’ å…è®¸</li>
            </ol>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–ç¯å¢ƒä¿¡æ¯
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ›´æ–°ç¯å¢ƒä¿¡æ¯
            document.getElementById('protocol').textContent = 'åè®®: ' + window.location.protocol;
            document.getElementById('hostname').textContent = 'ä¸»æœº: ' + window.location.hostname;
            document.getElementById('port').textContent = 'ç«¯å£: ' + (window.location.port || (window.location.protocol === 'https:' ? '443' : '80'));
            document.getElementById('secure').textContent = 'å®‰å…¨ä¸Šä¸‹æ–‡: ' + (window.isSecureContext ? 'æ˜¯' : 'å¦');
            
            // æ£€æµ‹è®¾å¤‡å’Œæµè§ˆå™¨
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const browser = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent) ? 'Safari' :
                           /Chrome/.test(navigator.userAgent) ? 'Chrome' :
                           /Firefox/.test(navigator.userAgent) ? 'Firefox' : 'å…¶ä»–';
            
            document.getElementById('device').textContent = 'è®¾å¤‡ç±»å‹: ' + (isIOS ? 'iOSè®¾å¤‡' : 'å…¶ä»–è®¾å¤‡');
            document.getElementById('browser').textContent = 'æµè§ˆå™¨: ' + browser;
            
            // å¦‚æœæ˜¯iOSè®¾å¤‡ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            if (isIOS) {
                document.getElementById('iosTips').style.display = 'block';
            }
            
            console.log('ç¯å¢ƒä¿¡æ¯æ›´æ–°å®Œæˆ');
            console.log('User Agent:', navigator.userAgent);
            console.log('æ”¯æŒgetUserMedia:', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
        });
        
        async function testMicrophone() {
            console.log('å¼€å§‹æµ‹è¯•éº¦å…‹é£æƒé™');
            
            const statusEl = document.getElementById('status');
            const btnEl = document.getElementById('testBtn');
            
            // æ›´æ–°çŠ¶æ€
            statusEl.className = 'status loading';
            statusEl.textContent = 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
            btnEl.disabled = true;
            btnEl.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                // æ£€æŸ¥åŸºæœ¬æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒgetUserMedia API');
                }
                
                console.log('å¼€å§‹è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                // æ£€æµ‹æ˜¯å¦ä¸ºiOSè®¾å¤‡ï¼Œä½¿ç”¨ä¸åŒçš„éŸ³é¢‘é…ç½®
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const audioConstraints = isIOS ? {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                } : {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                };
                
                console.log('ä½¿ç”¨éŸ³é¢‘é…ç½®:', audioConstraints);
                
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: audioConstraints 
                });
                
                console.log('âœ… æˆåŠŸè·å–éº¦å…‹é£æƒé™');
                console.log('éŸ³é¢‘è½¨é“æ•°é‡:', stream.getAudioTracks().length);
                
                // ç«‹å³åœæ­¢æµä»¥é‡Šæ”¾èµ„æº
                stream.getTracks().forEach(track => {
                    console.log('åœæ­¢éŸ³é¢‘è½¨é“:', track.kind);
                    track.stop();
                });
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… æˆåŠŸè·å–éº¦å…‹é£æƒé™ï¼ç°åœ¨å¯ä»¥ä½¿ç”¨å½•éŸ³åŠŸèƒ½äº†ã€‚';
                btnEl.textContent = 'ğŸ”„ é‡æ–°æµ‹è¯•';
                
            } catch (error) {
                console.error('éº¦å…‹é£æƒé™æµ‹è¯•å¤±è´¥:', error);
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                let errorMessage = 'âŒ éº¦å…‹é£æƒé™æµ‹è¯•å¤±è´¥: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®ã€‚';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·æ£€æŸ¥è®¾å¤‡è¿æ¥ã€‚';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®ã€‚';
                } else {
                    errorMessage += error.message;
                }
                
                statusEl.className = 'status error';
                statusEl.textContent = errorMessage;
                btnEl.textContent = 'ğŸ”„ é‡æ–°å°è¯•';
            } finally {
                btnEl.disabled = false;
            }
        }
    </script>
</body>
</html>
